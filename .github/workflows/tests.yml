name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # 手動実行を許可

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: チェックアウト
      uses: actions/checkout@v4

    - name: Python 3.12 のセットアップ
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: uv のセットアップ
      uses: astral-sh/setup-uv@v3

    - name: 依存関係のインストール
      run: |
        uv pip install -e ".[dev]"

    - name: ユニットテストの実行
      run: |
        uv run pytest tests/ -v -m "not integration" --cov=modules --cov-report=xml --cov-report=term-missing
        uv run coverage report --fail-under=80

    - name: カバレッジレポートの生成
      if: always()
      run: |
        echo "カバレッジレポートが生成されました"
        if [ -f coverage.xml ]; then
          echo "coverage.xml が存在します"
        fi

    - name: テスト結果サマリーの生成
      if: always()
      run: |
        echo "## テスト結果サマリー" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### テスト環境" >> $GITHUB_STEP_SUMMARY
        echo "- Python バージョン: 3.12" >> $GITHUB_STEP_SUMMARY
        echo "- ブランチ: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f coverage.xml ]; then
          echo "### カバレッジ率" >> $GITHUB_STEP_SUMMARY
          uv run coverage report --format=markdown >> $GITHUB_STEP_SUMMARY || true
        fi

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: チェックアウト
      uses: actions/checkout@v4

    - name: Python 3.12 のセットアップ
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: uv のセットアップ
      uses: astral-sh/setup-uv@v3

    - name: 依存関係のインストール
      run: |
        uv pip install -e ".[dev]"

    - name: Black (コードフォーマットチェック)
      run: |
        uv run black --check modules/ tests/

    - name: Ruff (リント・インポート順序チェック)
      run: |
        uv run ruff check modules/ tests/

    - name: Ruff フォーマッター
      run: |
        uv run ruff format --diff modules/ tests/

  security:
    runs-on: ubuntu-latest

    steps:
    - name: チェックアウト
      uses: actions/checkout@v4

    - name: Python 3.12 のセットアップ
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: uv のセットアップ
      uses: astral-sh/setup-uv@v3

    - name: 依存関係のインストール
      run: |
        uv pip install -e ".[dev]"

    - name: セキュリティツールのインストール
      run: |
        uv pip install bandit pip-audit

    - name: セキュリティチェック (bandit)
      run: |
        uv run bandit -r modules/ tests/ -f txt
      continue-on-error: true

    - name: 依存関係の脆弱性チェック (pip-audit)
      run: |
        uv run pip-audit
      continue-on-error: true
